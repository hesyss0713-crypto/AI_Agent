FROM ubuntu:24.04
WORKDIR /workspace
EXPOSE 9005 9006 9007 9008

# 각 agent 마다 포트 번호가 다 달라야함


# 패키지 관련 추가 명시

RUN apt-get update && apt-get install -y \
    build-essential \
    zlib1g-dev \
    libssl-dev \
    libpam0g-dev \
    libselinux1-dev \
    pkg-config \
    libedit-dev \
    gnupg ca-certificates \
    curl \
    systemd \
    xrdp \
    supervisor wget curl git net-tools \
    fluxbox fonts-liberation libxss1 lsb-release libappindicator3-1 \
    libasound2t64 libatk-bridge2.0-0 libatk1.0-0 libcups2 libgbm1 \
    libgtk-3-0 libnss3 libxcomposite1 libxdamage1 libxrandr2 \
    x11vnc xvfb fluxbox  \
    python3 python3-pip \
    openssh-server \
    tesseract-ocr-kor\
    onts-nanum \
    fonts-noto-cjk \
    fonts-unfonts-core \
    && apt clean


# openssh 설치

RUN curl -O https://cdn.openbsd.org/pub/OpenBSD/OpenSSH/portable/openssh-9.9p2.tar.gz && \
    tar -xzf openssh-9.9p2.tar.gz && \
    cd openssh-9.9p2 && \
    ./configure --sysconfdir=/etc/ssh --with-md5-passwords --with-pam && \
    make -j$(nproc) && \
    make install


# Google의 리포지토리 등록
RUN wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | apt-key add - && \
    sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-chrome.list'

RUN apt-get update && apt-get install -y google-chrome-stable


RUN mv /usr/sbin/sshd /usr/sbin/sshd.bak && \
    ln -s /usr/local/sbin/sshd /usr/sbin/sshd

# SSH 설정 디렉토리 생성
RUN mkdir -p /var/run/sshd && \
    echo 'root:root' | chpasswd

# SSH 설정 파일 복사 또는 수정 (필요 시)
# COPY sshd_config /etc/ssh/sshd_config


# 사용자 생성 아이디: tester 비밀번호: tester
RUN useradd -m -s /bin/bash llm && echo "tester:tester" | chpasswd && adduser tester sudo

# 사용자 홈에 .xsession 생성
USER tester
RUN echo "startxfce4" > ~/.xsession

# 다시 루트로 전환
USER root

# xrdp 설정
RUN systemctl enable xrdp

ENV DISPLAY=:1 

# NoVNC 설치 

RUN git clone https://github.com/novnc/noVNC.git /opt/noVNC && \
    git clone https://github.com/novnc/websockify /opt/noVNC/utils/websockify

# VNC 비밀번호 1234 , startup에서 비밀번호 인증없이 접근
RUN mkdir -p ~/.vnc && \
    x11vnc -storepasswd 1234 ~/.vnc/passwd

# startup 스크립트 복사 및 권한 부여
COPY ./startup.sh /opt/startup.sh
RUN chmod +x /opt/startup.sh


# 컨테이너 시작 시 스크립트 실행
CMD ["/bin/bash", "/opt/startup.sh"]